// src/lib/services/WelcomeMessageService.ts - VERSION AVEC DESCRIPTION DB

import type { ChatMessage, ConversationStep } from '@/types/chat';
import { supabase } from '@/lib/supabase';

export class WelcomeMessageService {
  private static instance: WelcomeMessageService;

  public static getInstance(): WelcomeMessageService {
    if (!this.instance) {
      this.instance = new WelcomeMessageService();
    }
    return this.instance;
  }

  /**
   * ‚úÖ G√âN√àRE LE MESSAGE D'ACCUEIL CORRECT selon vos sp√©cifications
   */
  public generateWelcomeMessage(
    productName: string,
    sessionId: string,
    productId: string,
    productPrice?: number
  ): ChatMessage {
    console.log('üåπ Generating CORRECT welcome message for:', { productName, sessionId, productId });
    
    return {
      type: 'assistant',
      content: `üëã Bonjour ! Je suis **Rose**, votre Assistante d'achat.

Je vois que vous vous int√©ressez √† notre jeu **${productName}**. C'est excellent ‚ú®

Comment puis-je vous aider ?`,
      choices: [
        'Je veux l\'acheter maintenant',
        'J\'ai des questions √† poser',
        'Je veux en savoir plus'
      ],
      assistant: {
        name: 'Rose',
        title: 'Assistante d\'achat',
        avatar: undefined
      },
      metadata: {
        nextStep: 'initial_engagement' as ConversationStep,
        productId: productId,
        sessionId: sessionId,
        flags: { 
          isWelcome: true,
          preventAIIntervention: true,
          autoGenerated: true
        }
      },
      timestamp: new Date().toISOString()
    };
  }

  /**
   * ‚úÖ VERSION DESKTOP du message d'accueil
   */
  public generateDesktopWelcomeMessage(
    productName: string,
    sessionId: string,
    productId: string,
    productPrice?: number,
    reviewCount?: number
  ): ChatMessage {
    console.log('üñ•Ô∏è Generating DESKTOP welcome message for:', { productName, sessionId, productId });
    
    return {
      type: 'assistant',
      content: `üëã Bonjour ! Je suis **Rose**, votre Assistante d'achat.

Je vois que vous vous int√©ressez √† notre jeu **${productName}**. C'est excellent ‚ú®

Comment puis-je vous aider ?`,
      choices: [
        'Je veux l\'acheter maintenant',
        'J\'ai des questions √† poser',
        'Je veux en savoir plus'
      ],
      assistant: {
        name: 'Rose',
        title: 'Assistante d\'achat'
      },
      metadata: {
        nextStep: 'initial_engagement' as ConversationStep,
        productId: productId,
        sessionId: sessionId,
        flags: { 
          isWelcome: true,
          isDesktop: true,
          preventAIIntervention: true,
          autoGenerated: true
        }
      },
      timestamp: new Date().toISOString()
    };
  }

  /**
   * ‚úÖ R√âCUP√âRER LA DESCRIPTION DU PRODUIT DEPUIS LA BASE DE DONN√âES
   */
  private async getProductDescription(productId: string): Promise<string> {
    try {
      const { data: product, error } = await supabase
        .from('products')
        .select('description, chatbot_variables, metadata, benefits, target_audience')
        .eq('id', productId)
        .single();

      if (error || !product) {
        console.error('‚ùå Error fetching product description:', error);
        return 'Un jeu de cartes r√©volutionnaire qui transforme vos conversations ordinaires en moments profonds et authentiques.';
      }

      // Prioriser la description directe
      if (product.description && product.description.trim().length > 0) {
        return product.description;
      }

      // Sinon, essayer les chatbot_variables
      if (product.chatbot_variables && typeof product.chatbot_variables === 'object') {
        const variables = product.chatbot_variables as any;
        if (variables.description) return variables.description;
        if (variables.product_description) return variables.product_description;
      }

      // Sinon, essayer les metadata
      if (product.metadata && typeof product.metadata === 'object') {
        const metadata = product.metadata as any;
        if (metadata.description) return metadata.description;
        if (metadata.product_description) return metadata.product_description;
      }

      // Sinon, construire √† partir des autres champs
      let constructedDescription = '';
      
      if (product.benefits) {
        constructedDescription += `**Les b√©n√©fices :**\n${product.benefits}\n\n`;
      }
      
      if (product.target_audience) {
        constructedDescription += `**Pour qui :**\n${product.target_audience}`;
      }

      return constructedDescription || 'Un jeu de cartes r√©volutionnaire pour am√©liorer vos relations.';
      
    } catch (error) {
      console.error('‚ùå Database error:', error);
      return 'Un jeu de cartes r√©volutionnaire qui transforme vos conversations ordinaires en moments profonds et authentiques.';
    }
  }

  /**
   * ‚úÖ G√àRE LES R√âPONSES AUX BOUTONS D'ACCUEIL avec r√©cup√©ration DB
   */
  public async handleWelcomeButtonResponse(
    choice: string,
    productId: string,
    productName: string
  ): Promise<ChatMessage> {
    
    // ‚úÖ 1. "Je veux l'acheter maintenant" ‚Üí Lancer le flow EXPRESS
    if (choice.includes('acheter maintenant') || choice.includes('acheter')) {
      return {
        type: 'assistant',
        content: `üõí **Parfait ! Commen√ßons votre commande express pour ${productName}**

Pour une commande rapide et efficace, j'ai besoin de quelques informations.

Combien d'exemplaires souhaitez-vous ?`,
        choices: [
          '1 exemplaire',
          '2 exemplaires',
          '3 exemplaires', 
          'Autre quantit√©'
        ],
        assistant: {
          name: 'Rose',
          title: 'Assistante d\'achat'
        },
        metadata: {
          nextStep: 'express_quantity' as ConversationStep,
          productId: productId,
          flags: { 
            expressMode: true,
            quantitySelection: true,
            preventDuplicateButtons: true
          }
        },
        timestamp: new Date().toISOString()
      };
    }

    // ‚úÖ 2. "J'ai des questions √† poser" ‚Üí Mode questions libres
    if (choice.includes('questions √† poser') || choice.includes('questions')) {
      return {
        type: 'assistant',
        content: `ü§î **Parfait ! Posez-moi toutes vos questions.**

Je connais **${productName}** sur le bout des doigts et je peux vous renseigner sur :

‚Ä¢ **Comment y jouer** et les r√®gles
‚Ä¢ **Pour qui** c'est adapt√©
‚Ä¢ **Les b√©n√©fices** concrets
‚Ä¢ **La livraison** et les d√©lais
‚Ä¢ **Tout ce que vous voulez savoir !**

Quelle est votre premi√®re question ?`,
        choices: [
          'Comment y jouer ?',
          'C\'est pour qui ?',
          'Quels sont les b√©n√©fices ?'
        ],
        assistant: {
          name: 'Rose',
          title: 'Assistante d\'achat'
        },
        metadata: {
          nextStep: 'question_mode' as ConversationStep,
          productId: productId,
          flags: { 
            questionMode: true,
            openToQuestions: true,
            preventDuplicateButtons: true
          }
        },
        timestamp: new Date().toISOString()
      };
    }

    // ‚úÖ 3. "Je veux en savoir plus" ‚Üí Description depuis la DB
    if (choice.includes('savoir plus') || choice.includes('en savoir plus')) {
      const productDescription = await this.getProductDescription(productId);
      
      return {
        type: 'assistant',
        content: `‚ú® **D√©couvrons ${productName} ensemble**

${productDescription}

Que voulez-vous d√©couvrir en premier ?`,
        choices: [
          'Comment y jouer ?',
          'C\'est pour qui ?',
          'Je veux l\'acheter maintenant'
        ],
        assistant: {
          name: 'Rose',
          title: 'Assistante d\'achat'
        },
        metadata: {
          nextStep: 'product_discovery' as ConversationStep,
          productId: productId,
          flags: { 
            discoveryMode: true,
            detailedInfo: true,
            preventDuplicateButtons: true
          }
        },
        timestamp: new Date().toISOString()
      };
    }

    // ‚úÖ Choix non reconnu - Rediriger
    return {
      type: 'assistant',
      content: `üòÖ **Je n'ai pas bien compris votre choix.**

Pouvez-vous me dire ce qui vous int√©resse le plus ?`,
      choices: [
        'Je veux l\'acheter maintenant',
        'J\'ai des questions √† poser',
        'Je veux en savoir plus'
      ],
      assistant: {
        name: 'Rose',
        title: 'Assistante d\'achat'
      },
      metadata: {
        nextStep: 'initial_engagement' as ConversationStep,
        productId: productId,
        flags: { 
          retryWelcome: true,
          preventDuplicateButtons: true
        }
      },
      timestamp: new Date().toISOString()
    };
  }

  /**
   * ‚úÖ VERSION SYNCHRONE pour compatibilit√© (utilise handleWelcomeButtonResponse en async)
   */
  public handleWelcomeButtonResponseSync(
    choice: string,
    productId: string,
    productName: string
  ): ChatMessage {
    // Pour les cas o√π on a besoin d'une r√©ponse imm√©diate sans await
    // On lance l'async en arri√®re-plan et retourne une r√©ponse temporaire
    
    if (choice.includes('savoir plus') || choice.includes('en savoir plus')) {
      // R√©ponse temporaire pendant le chargement
      return {
        type: 'assistant',
        content: `‚ú® **D√©couvrons ${productName} ensemble**

üéØ **En r√©sum√© :** ${productName} est un jeu de cartes r√©volutionnaire qui transforme vos conversations ordinaires en moments profonds et authentiques.

**üéÆ Comment √ßa marche :**
‚Ä¢ 150 cartes soigneusement con√ßues
‚Ä¢ Questions qui cr√©ent de vraies connexions
‚Ä¢ Adapt√© √† tous les niveaux de relation

**üíù Pourquoi √ßa fonctionne :**
‚Ä¢ Bas√© sur la psychologie des relations
‚Ä¢ Test√© par des centaines de couples/familles
‚Ä¢ R√©sultats visibles d√®s la premi√®re partie

Que voulez-vous d√©couvrir en premier ?`,
        choices: [
          'Comment y jouer ?',
          'C\'est pour qui ?',
          'Je veux l\'acheter maintenant'
        ],
        assistant: {
          name: 'Rose',
          title: 'Assistante d\'achat'
        },
        metadata: {
          nextStep: 'product_discovery' as ConversationStep,
          productId: productId,
          flags: { 
            discoveryMode: true,
            detailedInfo: true,
            preventDuplicateButtons: true
          }
        },
        timestamp: new Date().toISOString()
      };
    }

    // Pour les autres cas, retourner la version async directement
    return this.handleWelcomeButtonResponse(choice, productId, productName) as any;
  }

  /**
   * ‚úÖ V√âRIFIE SI UN MESSAGE EST UNE R√âPONSE AU MESSAGE D'ACCUEIL
   */
  public isWelcomeResponse(message: string): boolean {
    const welcomeResponses = [
      'je veux l\'acheter maintenant',
      'j\'ai des questions √† poser',
      'je veux en savoir plus',
      'acheter maintenant',
      'questions √† poser',
      'savoir plus'
    ];
    
    return welcomeResponses.some(response => 
      message.toLowerCase().includes(response.toLowerCase())
    );
  }

  /**
   * ‚úÖ G√âN√àRE UN MESSAGE DE R√âCUP√âRATION EN CAS D'ERREUR
   */
  public generateRecoveryMessage(productName: string, productId: string): ChatMessage {
    return {
      type: 'assistant',
      content: `üòä **Pas de souci ! Recommen√ßons.**

Je suis Rose, votre assistante pour **${productName}**.

Comment puis-je vous aider aujourd'hui ?`,
      choices: [
        'Je veux l\'acheter maintenant',
        'J\'ai des questions √† poser',
        'Je veux en savoir plus'
      ],
      assistant: {
        name: 'Rose',
        title: 'Assistante d\'achat'
      },
      metadata: {
        nextStep: 'initial_engagement' as ConversationStep,
        productId: productId,
        flags: { 
          isRecovery: true,
          preventDuplicateButtons: true
        }
      },
      timestamp: new Date().toISOString()
    };
  }
}